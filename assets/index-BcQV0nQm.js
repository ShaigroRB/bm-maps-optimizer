var z=Object.defineProperty;var Z=(t,e,s)=>e in t?z(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var _=(t,e,s)=>Z(t,typeof e!="symbol"?e+"":e,s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function s(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(n){if(n.ep)return;n.ep=!0;const i=s(n);fetch(n.href,i)}})();const Y=3,B=128,$={"Block (1x1)":{id:0,width:1*B,height:1*B},"Block (2x2)":{id:63,width:2*B,height:2*B},"Block (1x4)":{id:43,width:1*B,height:4*B},"Block (4x1)":{id:42,width:4*B,height:1*B}},J="Wall Tool",U=["Block (1x1)","Block (2x2)","Block (1x4)","Block (4x1)","Wall Tool"];class k{constructor(e,s,o=null){_(this,"type");_(this,"sound");_(this,"table");this.type=e,this.sound=s,this.table=o?[...o]:[]}get(e){return this.table[e]}set(e,s){this.table[e]=s}toString(){return`Type: ${this.type}
 Sound: ${this.sound}
 Table: ${JSON.stringify(this.table)}
`}}function q(t){const e=t.Config;return[Number(e.MapWidth),Number(e.MapHeight)]}function G(t,e){const s=[],o=[];for(const[n,i]of Object.entries(t))n!=="Config"&&e.includes(i.Name)?s.push(i):o.push(i);return[s,o]}function Q(t,e){const s=Array(t).fill(0);return Array(e).fill(null).map(()=>[...s])}function F(t,e,s){const o=t.X,n=t.Y;if(t.Name===e)return[Number(o),Number(n),Number(t.ObjWallWidth),Number(t.ObjWallHeight)];const i=s[t.Name];return[Number(o),Number(n),i.width,i.height]}function tt(t,e){for(let s=0;s<t.length;s++){const o=t[s];if(o.type===e.ObjType&&o.sound===e.ObjSound)return s}return-1}function D(t,e){return t%e===0}function et(t,e,s,o,n,i=1){const a=Math.floor(t/i),c=Math.floor(e/i),f=Q(a,c),d=[];function u(l,r){return l>=0&&l<a&&r>=0&&r<c}function p(l,r,g,m,T){const O=Math.floor(l/i),S=Math.floor(r/i),W=Math.floor(g/i),b=Math.floor(m/i);for(let y=S;y<S+b;y++)for(let L=O;L<O+W;L++)u(L,y)&&(T.table[y][L]=1)}function C(l,r){if(!D(l,i)||!D(r,i))return!1;const g=Math.floor(l/i),m=Math.floor(r/i);return u(g,m)}for(const l of s){const[r,g,m,T]=F(l,o,n);if(!C(r,g))continue;let O=tt(d,l);O===-1&&(O=d.length,d.push(new k(l.ObjType,l.ObjSound,JSON.parse(JSON.stringify(f))))),p(r,g,m,T,d[O])}return d}class ot{constructor(e,s,o,n,i,a){_(this,"x");_(this,"y");_(this,"width");_(this,"height");_(this,"type");_(this,"sound");this.x=e,this.y=s,this.width=o,this.height=n,this.type=i,this.sound=a}}function v(t){return t===1}function H(t){const e=t.length,s=e>0?t[0].length:0;for(let o=0;o<s;o++)for(let n=0;n<e;n++)if(v(t[n][o]))return[o,n];return[-1,-1]}function nt(t,e,s,o){for(let n=s;n<o;n++)if(!v(t[e][n]))return!1;return!0}function st(t,e){for(let s=t.y;s<t.height+t.y;s++)for(let o=t.x;o<t.width+t.x;o++)e[s][o]=0}function it(t){const e=t.type,s=t.sound,o=t.table.length,n=t.table[0].length,i=[],a=JSON.parse(JSON.stringify(t.table));function c(C,l,r,g){return new ot(C,l,r,g,e,s)}let[f,d]=H(a),u=d,p=f+1;for(;f!==-1&&d!==-1;){let C=!0;for(;p<n&&C;){const S=a[u][p];C=v(S),C&&p++}const l=p;u++;let r=!0;for(;u<o&&r;)r=nt(a,u,f,l),r&&u++;const g=u,m=l-f,T=g-d,O=c(f,d,m,T);i.push(O),st(O,a),[f,d]=H(a),u=d,p=f+1}return i}function rt(t,e,s){const o={};let n=!1;const i=(c,f)=>({X:(c.x*e).toString(),Y:(c.y*e).toString(),ObjWallWidth:(c.width*e).toString(),ObjWallHeight:(c.height*e).toString(),ID:f.toString(),ObjIndexID:"46",Name:"Wall Tool",LogidID:f.toString(),Poly:"0",ObjIsTile:"0",Depth:"500",ObjType:c.type,ObjSound:c.sound,Team:"-1"});s.forEach((c,f)=>{"Author"in c?o.Config=c:o[`OBJ${f}`]=c}),t.forEach((c,f)=>{const d=s.length+f;o[`OBJ${d}`]=i(c,d)});let a="";try{a=JSON.stringify(o)}catch{n=!0,console.error('Failed to serialize via "JSON.stringify"')}return n?[JSON.stringify(o),n]:[a,n]}const lt="#808080",ct="#00ff00",at="#ffff00",ft="#ffa040",dt="#ff0000",ht="#ff00ff",ut="#008080",gt="#000080",pt="#9f31c6",Ot="#ff6200",X={0:lt,1:ct,2:at,3:ft,4:dt,5:ht,6:ut,7:gt,8:"#ffffff",9:pt,10:Ot},V=32,E=B/V,h=20/V,I=document.getElementById("progress");function mt(t,e,s){console.clear(),I.value=0;const o=t,n=JSON.parse(o[Y]),[i,a]=q(n),[c,f]=G(n,U);I.value=5;const d=et(i,a,c,J,$,E);I.value=15,e.width=i/E*h,e.height=a/E*h,s.width=e.width,s.height=e.height;const u=e.getContext("2d"),p=s.getContext("2d");c.forEach(b=>{const[y,L,x,M]=F(b,J,$),[N,w,j,P]=[Math.floor(y/E),Math.floor(L/E),Math.floor(x/E),Math.floor(M/E)];u.fillStyle="blue",(j===0||P===0)&&(console.log(`x: ${y}, y: ${L}, width: ${x}, height: ${M}, scaledX: ${N}, scaledY: ${w}, scaledWidth: ${j}, scaledHeight: ${P}`),u.fillStyle="red"),u.fillRect(N*h,w*h,j*h,P*h),u.fillStyle=X[b.ObjType],u.fillRect(N*h+2,w*h+2,j*h-4,P*h-4)});let C=80/d.length,l=[];d.forEach(b=>{const y=it(b);l=[...l,...y],I.value+=C,y.forEach(L=>{const{x,y:M,width:N,height:w}=L;p.fillStyle="black",p.fillRect(x*h,M*h,h*N,h*w),p.fillStyle=X[b.type],p.fillRect(x*h+2,M*h+2,h*N-4,h*w-4)})});const r=c.length,g=l.length,m=Math.floor((1-g/r)*100);if(console.log(`Before: ${r}, After: ${g}`),console.log(`Compression ratio: ${m}%`),g>=r)return console.log("No optimization to be made"),[t,{before:r,after:r,ratio:0,hasCrashed:!1}];const[T,O]=rt(l,E,f),S={before:r,after:g,ratio:m,hasCrashed:O},W=[...o.slice(0,Y),T,o[Y+1]];return I.value=100,[W,S]}const K=document.getElementById("input_load_file"),yt=document.getElementById("map_content"),_t=document.getElementById("before"),Ct=document.getElementById("after"),Lt=document.getElementById("ratio"),Bt=document.getElementById("og_map_canvas"),R=document.getElementById("optimized_map_canvas");R.addEventListener("mouseenter",()=>R.className="disappear");R.addEventListener("mouseleave",()=>R.className="");let A=[];K.addEventListener("change",async()=>{var n;const t=(n=K.files)==null?void 0:n[0];if(A=[],!t)return;const e=await t.text();A.push(...e.split(`\r
`));const[s,o]=mt(A,Bt,R);if(o.has_crashed){alert("The optimization has crashed! This map is not suitable for optimization.");return}yt.value=s.join(`
`),_t.textContent=o.before.toString(),Ct.textContent=o.after.toString(),Lt.textContent=o.ratio.toString()});
